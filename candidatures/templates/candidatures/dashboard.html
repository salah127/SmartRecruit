<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tableau de Bord - SmartRecruit</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      }
      .stats-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }
      .stats-card.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      }
      .stats-card.info {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      }
      .chart-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px 0;
        margin-bottom: 30px;
        border-radius: 0 0 20px 20px;
      }
    </style>
  </head>
  <body style="background-color: #f8f9fa">
    <div class="dashboard-header">
      <div class="container">
        <h1><i class="fas fa-chart-dashboard me-3"></i>Tableau de Bord</h1>
        <p class="mb-0">Vue d'ensemble des candidatures et statistiques</p>
      </div>
    </div>

    <div class="container">
      <!-- Debug Info -->
      <div class="alert alert-info" id="debug-info" style="display: none">
        <h5>Debug Info:</h5>
        <div id="debug-content"></div>
      </div>

      <!-- Stats Cards -->
      <div class="row">
        <div class="col-lg-2 col-md-4 col-sm-6">
          <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 id="total-candidatures">Chargement...</h3>
                <p class="mb-0">Total Candidatures</p>
              </div>
              <i class="fas fa-users fa-2x opacity-75"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
          <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 id="candidatures-attente">Chargement...</h3>
                <p class="mb-0">En Attente</p>
              </div>
              <i class="fas fa-clock fa-2x opacity-75"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
          <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 id="candidatures-acceptees">Chargement...</h3>
                <p class="mb-0">Acceptées</p>
              </div>
              <i class="fas fa-check-circle fa-2x opacity-75"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
          <div
            class="stats-card"
            style="
              background: linear-gradient(135deg, #fd746c 0%, #ff9068 100%);
            "
          >
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 id="candidatures-refusees">Chargement...</h3>
                <p class="mb-0">Refusées</p>
              </div>
              <i class="fas fa-times-circle fa-2x opacity-75"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
          <div class="stats-card info">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 id="candidatures-en-cours">Chargement...</h3>
                <p class="mb-0">En cours</p>
              </div>
              <i class="fas fa-cog fa-2x opacity-75"></i>
            </div>
          </div>
        </div>

        <div class="col-lg-2 col-md-4 col-sm-6">
          <div
            class="stats-card"
            style="
              background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            "
          >
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h3 id="temps-traitement">Chargement...</h3>
                <p class="mb-0">Jours de traitement</p>
              </div>
              <i class="fas fa-hourglass-half fa-2x opacity-75"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Button -->
      <div class="row mb-3">
        <div class="col-12">
          <button class="btn btn-primary" onclick="testAPI()">
            Tester l'API
          </button>
          <button class="btn btn-secondary" onclick="toggleDebug()">
            Toggle Debug
          </button>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row">
        <div class="col-lg-8">
          <div class="chart-container">
            <h5>
              <i class="fas fa-chart-line me-2"></i>Évolution des Candidatures
            </h5>
            <canvas id="evolutionChart" height="100"></canvas>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="chart-container">
            <h5><i class="fas fa-chart-pie me-2"></i>Répartition par Statut</h5>
            <canvas id="statutChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let evolutionChart, statutChart;

      // Fonction pour obtenir le token CSRF
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Fonction de test API
      async function testAPI() {
        try {
          const response = await fetch("/api/dashboard/stats/", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
          });

          const data = await response.json();

          document.getElementById("debug-content").innerHTML = `
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Response:</strong></p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

          if (response.ok) {
            updateStatsCards(data.statistiques_generales);
          } else {
            alert("Erreur: " + (data.error || "Erreur inconnue"));
          }
        } catch (error) {
          console.error("Erreur:", error);
          document.getElementById("debug-content").innerHTML = `
                    <p><strong>Erreur:</strong> ${error.message}</p>
                `;
          alert("Erreur de connexion: " + error.message);
        }
      }

      // Toggle debug
      function toggleDebug() {
        const debugDiv = document.getElementById("debug-info");
        debugDiv.style.display =
          debugDiv.style.display === "none" ? "block" : "none";
      }

      // Fonction pour mettre à jour les cartes de statistiques
      function updateStatsCards(stats) {
        document.getElementById("total-candidatures").textContent =
          stats.total_candidatures || "0";
        document.getElementById("candidatures-attente").textContent =
          stats.candidatures_en_attente || "0";
        document.getElementById("candidatures-acceptees").textContent =
          stats.candidatures_acceptees || "0";
        document.getElementById("candidatures-refusees").textContent =
          stats.candidatures_refusees || "0";
        document.getElementById("candidatures-en-cours").textContent =
          stats.candidatures_en_cours || "0";
        document.getElementById("temps-traitement").textContent =
          (stats.temps_traitement_moyen || "0") + " j";
      }

      // Graphique d'évolution
      async function loadEvolutionChart() {
        try {
          const response = await fetch(
            "/api/dashboard/charts/?type=evolution",
            {
              headers: { "X-CSRFToken": getCookie("csrftoken") },
            }
          );

          if (!response.ok) {
            console.error("Erreur response evolution:", response.status);
            return;
          }

          const data = await response.json();

          const ctx = document
            .getElementById("evolutionChart")
            .getContext("2d");
          if (evolutionChart) evolutionChart.destroy();

          evolutionChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: data.labels || ["Aucune donnée"],
              datasets: [
                {
                  label: "Candidatures",
                  data: data.data || [0],
                  borderColor: "#667eea",
                  backgroundColor: "rgba(102, 126, 234, 0.1)",
                  tension: 0.4,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true } },
            },
          });
        } catch (error) {
          console.error("Erreur graphique évolution:", error);
        }
      }

      // Graphique des statuts
      async function loadStatutChart() {
        try {
          const response = await fetch("/api/dashboard/charts/?type=statuts", {
            headers: { "X-CSRFToken": getCookie("csrftoken") },
          });

          if (!response.ok) {
            console.error("Erreur response statuts:", response.status);
            return;
          }

          const data = await response.json();

          const ctx = document.getElementById("statutChart").getContext("2d");
          if (statutChart) statutChart.destroy();

          statutChart = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: data.labels || ["Aucune donnée"],
              datasets: [
                {
                  data: data.data || [1],
                  backgroundColor: data.colors || ["#ccc"],
                  borderWidth: 2,
                  borderColor: "#fff",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { position: "bottom" } },
            },
          });
        } catch (error) {
          console.error("Erreur graphique statuts:", error);
        }
      }

      // Initialisation
      document.addEventListener("DOMContentLoaded", function () {
        testAPI();
        loadEvolutionChart();
        loadStatutChart();
      });
    </script>
  </body>
</html>
