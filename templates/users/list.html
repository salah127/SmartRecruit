{% extends 'base.html' %} {% block title %}Utilisateurs - SmartRecruit{%endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-users me-2"></i>Gestion des Utilisateurs</h2>
  <button
    class="btn btn-primary"
    data-bs-toggle="modal"
    data-bs-target="#addUserModal"
  >
    <i class="fas fa-user-plus me-2"></i>Ajouter un utilisateur
  </button>
</div>

<!-- Filters -->
<div class="row mb-4">
  <div class="col-md-3">
    <select class="form-select" id="roleFilter">
      <option value="">Tous les rôles</option>
      <option value="admin">Administrateurs</option>
      <option value="recruteur">Recruteurs</option>
      <option value="candidat">Candidats</option>
    </select>
  </div>
  <div class="col-md-6">
    <input
      type="text"
      class="form-control"
      id="searchInput"
      placeholder="Rechercher par nom, email..."
    />
  </div>
  <div class="col-md-3">
    <button class="btn btn-outline-secondary w-100" onclick="exportUsers()">
      <i class="fas fa-download me-2"></i>Exporter
    </button>
  </div>
</div>

<!-- Users Table -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover" id="usersTable">
        <thead>
          <tr>
            <th>Utilisateur</th>
            <th>Email</th>
            <th>Rôle</th>
            <th>Téléphone</th>
            <th>Date d'inscription</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user_item in users %}
          <tr data-role="{{ user_item.role }}">
            <td>
              <div class="d-flex align-items-center">
                <i class="fas fa-user-circle fa-2x text-primary me-3"></i>
                <div>
                  <h6 class="mb-0">
                    {{ user_item.first_name }} {{ user_item.last_name }}
                  </h6>
                  <small class="text-muted">{{ user_item.username }}</small>
                </div>
              </div>
            </td>
            <td>{{ user_item.email }}</td>
            <td>
              <span
                class="badge {% if user_item.role == 'admin' %}bg-danger {% elif user_item.role == 'recruteur' %}bg-warning {% else %}bg-primary{% endif %} badge-role"
              >
                {{ user_item.get_role_display }}
              </span>
            </td>
            <td>{{ user_item.phone|default:"-" }}</td>
            <td>{{ user_item.created_at|date:"d/m/Y" }}</td>
            <td>
              <span
                class="badge {% if user_item.is_active %}bg-success{% else %}bg-secondary{% endif %}"
              >
                {% if user_item.is_active %}Actif{% else %}Inactif{% endif %}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button
                  class="btn btn-outline-primary"
                  onclick="editUser({{ user_item.id }})"
                  title="Modifier"
                >
                  <i class="fas fa-edit"></i>
                </button>
                {% if user_item.is_active %}
                <button
                  class="btn btn-outline-warning"
                  onclick="toggleUserStatus({{ user_item.id }}, false)"
                  title="Désactiver"
                >
                  <i class="fas fa-user-slash"></i>
                </button>
                {% else %}
                <button
                  class="btn btn-outline-success"
                  onclick="toggleUserStatus({{ user_item.id }}, true)"
                  title="Activer"
                >
                  <i class="fas fa-user-check"></i>
                </button>
                {% endif %} {% if user_item != user %}
                <button
                  class="btn btn-outline-danger"
                  onclick="deleteUser({{ user_item.id }})"
                  title="Supprimer"
                >
                  <i class="fas fa-trash"></i>
                </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center py-4">
              <i class="fas fa-users fa-3x text-muted mb-3"></i>
              <p class="text-muted">Aucun utilisateur trouvé</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ajouter un utilisateur</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <form id="addUserForm">
        <div class="modal-body">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Prénom</label>
              <input
                type="text"
                class="form-control"
                name="first_name"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Nom</label>
              <input
                type="text"
                class="form-control"
                name="last_name"
                required
              />
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Nom d'utilisateur</label>
            <input type="text" class="form-control" name="username" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Téléphone</label>
            <input type="tel" class="form-control" name="phone" />
          </div>
          <div class="mb-3">
            <label class="form-label">Rôle</label>
            <select class="form-select" name="role" required>
              <option value="">Choisir un rôle</option>
              <option value="candidat">Candidat</option>
              <option value="recruteur">Recruteur</option>
              <option value="admin">Administrateur</option>
            </select>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Mot de passe</label>
              <input
                type="password"
                class="form-control"
                name="password"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Confirmer le mot de passe</label>
              <input
                type="password"
                class="form-control"
                name="password_confirm"
                required
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Annuler
          </button>
          <button type="submit" class="btn btn-primary">
            Créer l'utilisateur
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block extra_js %}
<script>
  // Search functionality
  document.getElementById("searchInput").addEventListener("input", function () {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll("#usersTable tbody tr");

    rows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? "" : "none";
    });
  });

  // Role filter
  document.getElementById("roleFilter").addEventListener("change", function () {
    const selectedRole = this.value;
    const rows = document.querySelectorAll("#usersTable tbody tr");

    rows.forEach((row) => {
      if (!selectedRole || row.dataset.role === selectedRole) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  });

  // Add user form submission
  document
    .getElementById("addUserForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const password = formData.get("password");
      const passwordConfirm = formData.get("password_confirm");

      if (password !== passwordConfirm) {
        alert("Les mots de passe ne correspondent pas");
        return;
      }

      // Here you would typically make an AJAX call to create the user
      fetch("/api/users/", {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            location.reload();
          } else {
            alert("Erreur lors de la création de l'utilisateur");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Erreur lors de la création de l'utilisateur");
        });
    });

  function editUser(userId) {
    // Implement edit user functionality
    console.log("Edit user:", userId);
  }

  function toggleUserStatus(userId, activate) {
    // Implement toggle user status functionality
    console.log("Toggle user status:", userId, activate);
  }

  function deleteUser(userId) {
    if (confirm("Êtes-vous sûr de vouloir supprimer cet utilisateur ?")) {
      // Implement delete user functionality
      console.log("Delete user:", userId);
    }
  }

  function exportUsers() {
    // Implement export functionality
    console.log("Export users");
  }
</script>
{% endblock %}
